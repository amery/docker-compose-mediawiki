# vim: set ft=yaml ts=2 sw=2 et:
version: '3'

volumes:
  wiki:
    driver: local
    driver_opts:
      type: overlay
      o: "lowerdir=${PWD}/mediawiki,upperdir=${PWD}/overlay,workdir=${PWD}/.overlay"
      device: overlay

services:

  @@NAME@@:
    container_name: mediawiki
    build: ./docker

    restart: always
    volumes:
      - wiki:/srv/http/wiki
      - "${PWD}/extensions:/srv/http/wiki/extensions"
    networks:
      - default

  nginx:
    container_name: nginx
    image: @@NGINX_IMAGE@@

    restart: always
    volumes:
      - "wiki:/srv/http/wiki"
      - "./extensions:/srv/http/wiki/extensions"
      - "./nginx.conf:/etc/nginx/conf.d/default.conf"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.@@NAME@@.rule=Host(`@@HOSTNAME@@`)"
      - "traefik.http.routers.@@NAME@@.service=@@NAME@@"
      - "traefik.http.services.@@NAME@@.loadbalancer.server.port=80"

    depends_on:
      - @@NAME@@
    networks:
      - default
      - @@TRAEFIK_BRIDGE@@

networks:
  @@TRAEFIK_BRIDGE@@:
    external: true
  default:
